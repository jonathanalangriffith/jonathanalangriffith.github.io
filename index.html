<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Meet Pro - Lap Analyzer</title>
    <style>
        :root { --primary: #1a73e8; --success: #27ae60; --danger: #e74c3c; --warn: #f39c12; --bg: #f0f2f5; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 10px; color: #333; margin: 0; }
        .container { max-width: 600px; margin: auto; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden; }
        .tabs { display: flex; background: #eee; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom-color: var(--primary); color: var(--primary); background: white; }
        .content { padding: 20px; display: none; }
        .content.active { display: block; }
        .section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        input, select, button, textarea { padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; width: 100%; box-sizing: border-box; }
        .btn { font-weight: bold; border: none; cursor: pointer; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-warn { background: var(--warn); }
        .btn-danger { background: var(--danger); }
        .master-clock { font-size: 3.5rem; font-weight: 800; text-align: center; margin: 15px 0; font-family: monospace; color: var(--danger); background: #fff5f5; border-radius: 10px; padding: 10px; }
        .athlete-card { border-left: 6px solid var(--primary); padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 8px; }
        .athlete-card.finished { border-left-color: #333; background-color: #eee; }
        .athlete-info { display: flex; justify-content: space-between; align-items: center; }
        .split-grid { margin-top: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; }
        .split-tag { background: #fff; border: 1px solid #ddd; padding: 5px; border-radius: 4px; font-size: 0.75rem; line-height: 1.2; }
        .lap-time { color: var(--primary); font-weight: bold; display: block; }
        .total-time { color: #666; display: block; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <div class="tab active" onclick="switchTab('timer')">Timer</div>
        <div class="tab" onclick="switchTab('roster')">Team Roster</div>
    </div>

    <div id="timer" class="content active">
        <div class="section">
            <input type="text" id="meetName" placeholder="Meet Name" style="margin-bottom: 10px;">
            <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                <select id="raceDistance" onchange="renderActiveRoster()">
                    <option value="100">100m</option><option value="200">200m</option><option value="400">400m</option>
                    <option value="800">800m</option><option value="1600" selected>1600m</option><option value="3200">3200m</option>
                </select>
                <select id="gender" onchange="updateRosterSelect()">
                    <option value="Boys">Boys</option><option value="Girls">Girls</option>
                </select>
            </div>
            <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 5px;">
                <select id="rosterSelect"></select>
                <input type="text" id="targetTime" placeholder="Goal (M:SS)">
                <button class="btn btn-primary" onclick="addAthleteFromRoster()">Add</button>
            </div>
            <button class="btn btn-success" id="startBtn" onclick="startRace()" style="margin-top:10px;">START HEAT</button>
        </div>

        <div class="master-clock" id="display">00:00.00</div>
        <div id="activeRoster"></div>
        <button class="btn btn-warn" id="saveHeatBtn" onclick="saveHeatToHistory()" style="display:none; margin-top:10px;">FINISH & SAVE HEAT</button>
        <button class="btn btn-primary" onclick="exportFullMeet()" style="margin-top:20px;">EXPORT FULL MEET TO EXCEL</button>
    </div>

    <div id="roster" class="content">
        <h3>Roster Management</h3>
        <textarea id="boysInput" rows="4" placeholder="Boys names (comma separated)"></textarea>
        <textarea id="girlsInput" rows="4" placeholder="Girls names (comma separated)" style="margin-top:10px;"></textarea>
        <button class="btn btn-primary" onclick="saveMasterRoster()" style="margin-top:10px;">Save Team Roster</button>
    </div>
</div>

<script>
    let startTime, running = false, athletes = [], interval;
    const lapMap = { "100": 1, "200": 1, "400": 1, "800": 2, "1600": 4, "3200": 8 };

    window.onload = () => { loadMasterRoster(); updateRosterSelect(); };

    function switchTab(t) {
        document.querySelectorAll('.tab, .content').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById(t).classList.add('active');
    }

    function formatTime(ms) {
        let m = Math.floor(ms/60000), s = Math.floor((ms%60000)/1000), c = Math.floor((ms%1000)/10);
        return `${m}:${s.toString().padStart(2,'0')}.${c.toString().padStart(2,'0')}`;
    }

    function saveMasterRoster() {
        const boys = document.getElementById('boysInput').value.split(',').map(s => s.trim()).filter(s => s);
        const girls = document.getElementById('girlsInput').value.split(',').map(s => s.trim()).filter(s => s);
        localStorage.setItem('masterRoster', JSON.stringify({ boys, girls }));
        updateRosterSelect();
        alert("Roster Saved!");
    }

    function loadMasterRoster() {
        const data = JSON.parse(localStorage.getItem('masterRoster') || '{"boys":[],"girls":[]}');
        document.getElementById('boysInput').value = data.boys.join(', ');
        document.getElementById('girlsInput').value = data.girls.join(', ');
    }

    function updateRosterSelect() {
        const gen = document.getElementById('gender').value.toLowerCase();
        const data = JSON.parse(localStorage.getItem('masterRoster') || '{"boys":[],"girls":[]}');
        const sel = document.getElementById('rosterSelect');
        sel.innerHTML = '<option value="">Select Athlete...</option>';
        data[gen].forEach(n => sel.innerHTML += `<option value="${n}">${n}</option>`);
    }

    function addAthleteFromRoster() {
        const name = document.getElementById('rosterSelect').value;
        if (!name || running) return;
        athletes.push({ name, splits: [], splitsMs: [], lapTimes: [], finished: false });
        renderActiveRoster();
    }

    function renderActiveRoster() {
        const container = document.getElementById('activeRoster');
        const dist = document.getElementById('raceDistance').value;
        const totalLaps = lapMap[dist];
        container.innerHTML = '';
        athletes.forEach((a, i) => {
            const div = document.createElement('div');
            div.className = `athlete-card ${a.finished ? 'finished' : ''}`;
            div.innerHTML = `
                <div class="athlete-info">
                    <strong>${a.name}</strong>
                    ${a.finished ? 'üèÅ' : `<button class="btn btn-warn" onclick="recordSplit(${i})" ${!running ? 'disabled' : ''} style="width:auto;">SPLIT</button>`}
                </div>
                <div class="split-grid">
                    ${a.splits.map((s, idx) => `
                        <div class="split-tag">
                            <span class="lap-time">Lap ${idx+1}: ${a.lapTimes[idx]}</span>
                            <span class="total-time">Total: ${s}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(div);
        });
    }

    function startRace() {
        if (!athletes.length) return;
        running = true;
        startTime = Date.now();
        interval = setInterval(() => document.getElementById('display').innerText = formatTime(Date.now()-startTime), 10);
        document.getElementById('startBtn').disabled = true;
        document.getElementById('saveHeatBtn').style.display = 'block';
    }

    function recordSplit(i) {
        const totalLaps = lapMap[document.getElementById('raceDistance').value];
        const elapsed = Date.now() - startTime;
        const a = athletes[i];
        if (a.splits.length < totalLaps) {
            const lastSplitMs = a.splitsMs.length > 0 ? a.splitsMs[a.splitsMs.length-1] : 0;
            const currentLapMs = elapsed - lastSplitMs;
            
            a.splits.push(formatTime(elapsed));
            a.splitsMs.push(elapsed);
            a.lapTimes.push(formatTime(currentLapMs));
            
            if (a.splits.length == totalLaps) a.finished = true;
            renderActiveRoster();
        }
    }

    function saveHeatToHistory() {
        const history = JSON.parse(localStorage.getItem('meetHistory') || '[]');
        history.push({
            meetName: document.getElementById('meetName').value || "Meet",
            gender: document.getElementById('gender').value,
            distance: document.getElementById('raceDistance').value + 'm',
            athletes: JSON.parse(JSON.stringify(athletes)),
            date: new Date().toLocaleDateString()
        });
        localStorage.setItem('meetHistory', JSON.stringify(history));
        athletes = []; running = false; clearInterval(interval);
        document.getElementById('display').innerText = "00:00.00";
        document.getElementById('startBtn').disabled = false;
        document.getElementById('saveHeatBtn').style.display = 'none';
        renderActiveRoster();
    }

    function exportFullMeet() {
        const history = JSON.parse(localStorage.getItem('meetHistory') || '[]');
        let csv = "Meet,Date,Gender,Dist,Athlete,Final,L1_Split,L1_Lap,L2_Split,L2_Lap,L3_Split,L3_Lap,L4_Split,L4_Lap\n";
        history.forEach(h => {
            h.athletes.forEach(a => {
                let row = [h.meetName, h.date, h.gender, h.distance, a.name, a.splits[a.splits.length-1]];
                a.splits.forEach((s, idx) => {
                    row.push(s); // Cumulative
                    row.push(a.lapTimes[idx]); // Individual Lap
                });
                csv += row.join(',') + "\n";
            });
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Meet_Results.csv`;
        a.click();
    }
</script>
</body>
</html>
